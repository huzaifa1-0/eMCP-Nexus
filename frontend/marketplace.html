<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(to bottom, #000, #001f3f);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header styling to match page5.html */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            background: rgba(0, 0, 0, 0.8);
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-links a {
            color: #ccc;
            text-decoration: none;
            font-size: 16px;
        }
        
        .nav-links a:hover {
            color: #fff;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .search-container {
            background: rgba(18, 18, 18, 0.9);
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }
        
        .search-box {
            display: flex;
            gap: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(30, 30, 30, 0.7);
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 16px;
            color: #fff;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #4cc9f0;
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.3);
        }
        
        .search-input::placeholder {
            color: #888;
        }
        
        .search-btn {
            padding: 12px 25px;
            background: linear-gradient(45deg, #4cc9f0, #4361ee);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .search-btn:hover {
            background: linear-gradient(45deg, #4361ee, #4cc9f0);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.4);
        }
        
        .results-count {
            margin-top: 15px;
            color: #fff;
            font-weight: 500;
        }
        
        .divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 30px 0;
        }
        
        .mcp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .mcp-card {
            background: rgba(18, 18, 18, 0.9);
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .mcp-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
        }
        
        .mcp-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .mcp-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }
        
        .mcp-badge {
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .mcp-status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 6px;
            background: rgba(45, 45, 45, 0.7);
            color: #ccc;
            font-style: italic;
            text-align: center;
        }
        
        .mcp-config {
            margin: 15px 0;
            padding: 10px;
            border-radius: 6px;
            background: rgba(51, 51, 34, 0.7);
            color: #ccc;
            text-align: center;
            font-weight: 500;
        }
        
        .mcp-date {
            color: #999;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .tools-section {
            margin-top: 20px;
        }
        
        .tools-title {
            font-weight: 600;
            color: #fff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tool-item {
            background: rgba(45, 45, 45, 0.7);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 3px solid rgba(68, 68, 68, 0.7);
        }
        
        .tool-name {
            font-weight: 600;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .tool-desc {
            color: #ccc;
            font-size: 14px;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #fff;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4cc9f0, #4361ee);
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #4361ee, #4cc9f0);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            font-size: 12px;
            color: #ccc;
            margin-top: 40px;
        }
        
        @media (max-width: 900px) {
            .mcp-grid {
                grid-template-columns: 1fr;
            }
            
            .main-header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                gap: 15px;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
        /* Voice Search Animation */
        @keyframes pulse-red {
            0% { transform: scale(1); text-shadow: 0 0 0 rgba(255, 77, 77, 0.7); }
            50% { transform: scale(1.1); text-shadow: 0 0 10px rgba(255, 77, 77, 0.8); }
            100% { transform: scale(1); text-shadow: 0 0 0 rgba(255, 77, 77, 0.7); }
        }

        .listening {
            color: #ff4d4d !important; /* Red color when active */
            animation: pulse-red 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header matching page5.html design -->
        <header class="main-header">
            <div class="logo">⚡ eMCP Nexus</div>
            <nav class="nav-links">
                <a href="#features">Features</a>
                <a href="seller_dashboard.html">Seller Dashboard</a>
                <a href="#security">Security</a>
            </nav>
        </header>
        
        <div class="alert">
            <i class="fas fa-info-circle"></i>
            Discover and integrate Modular Compute Protocol tools into your applications
        </div>
        
        <div class="page-header">
            <div class="page-title">
                <i class="fas fa-store"></i>
                MCP Marketplace
            </div>
            <div class="status-badge" id="statusBadge">
                <i class="fas fa-check-circle"></i>
                Loading...
            </div>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <div style="position: relative; flex: 1; display: flex; align-items: center;">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search eMCPs, tools, or descriptions..." style="padding-right: 45px; width: 100%;">
        
                    <button id="voiceBtn" type="button" style="position: absolute; right: 10px; background: none; border: none; color: #888; cursor: pointer; font-size: 18px; transition: all 0.3s ease;" title="Search by voice">
                    <i class="fas fa-microphone"></i>
                    </button>
                </div>

                <button id="searchBtn" class="search-btn">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            <div class="results-count" id="resultsCount">Loading...</div>
        </div>
        
        <div class="divider"></div>
        
        <div class="mcp-grid" id="mcpGrid">
            </div>
        </div>
    
        <footer>
            © 2025 eMCP Nexus. Powered by Civic Auth and Web3 technology.
        </footer>
    </div>

   <script>
        const API_BASE_URL = '/api';
        
        document.addEventListener('DOMContentLoaded', function() {
            fetchTools();
            
            // Search functionality
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') performSearch();
            });
        });

        let allTools = [];

        // 1. Fetch Tools from Backend
        async function fetchTools() {
            const grid = document.getElementById('mcpGrid');
            const statusBadge = document.getElementById('statusBadge');
            const resultsCount = document.getElementById('resultsCount');

            try {
                const response = await fetch(`${API_BASE_URL}/tools/`);
                if (!response.ok) throw new Error("Failed to fetch tools");
                
                allTools = await response.json();
                const count = allTools.length;

                const label = count === 1 ? 'eMCP tool available' : 'eMCP tools available';
                
                // Update counts
                if (statusBadge) statusBadge.innerHTML = `<i class="fas fa-check-circle"></i> ${allTools.length} eMCPs available`;
                if (resultsCount) resultsCount.innerText = `${allTools.length} eMCPs available`;

                // Render
                renderTools(allTools);
                
            } catch (error) {
                console.error(error);
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #ff6b6b;">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3>Failed to load marketplace</h3>
                        <p>Could not connect to the backend.</p>
                    </div>`;
                if (statusBadge) statusBadge.innerHTML = `<i class="fas fa-times-circle"></i> Offline`;
            }
        }

        // 2. Render Tools (Handles Empty State)
        function renderTools(tools) {
            const grid = document.getElementById('mcpGrid');
            grid.innerHTML = ''; // Clear existing content

            // ✅ SHOW THIS IF NO TOOLS EXIST
            if (tools.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #ccc;">
                        <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 20px; color: #4cc9f0;"></i>
                        <h3 style="font-size: 24px; margin-bottom: 10px;">No tools yet</h3>
                        <p style="margin-bottom: 20px;">The marketplace is empty. Be the first to publish a tool!</p>
                        <a href="seller_dashboard.html" class="btn btn-primary" style="text-decoration: none; display: inline-block;">
                            <i class="fas fa-plus"></i> Go to Dashboard
                        </a>
                    </div>`;
                return;
            }

            // ✅ RENDER CARDS IF TOOLS EXIST
            tools.forEach(tool => {
                const card = document.createElement('div');
                card.className = 'mcp-card';
                card.innerHTML = `
                    <div class="mcp-header">
                        <div class="mcp-title">${tool.name}</div>
                        <div class="mcp-badge">eMCP service deployment</div>
                    </div>
                    
                    <div class="mcp-status" style="color: #4cc9f0; background: rgba(76, 201, 240, 0.1);">
                        <i class="fas fa-check-circle"></i> Active & Ready
                    </div>
                    
                    <div class="mcp-config" style="text-align: left; font-size: 13px; padding: 15px;">
                        <div style="margin-bottom: 5px;"><strong>Description:</strong></div>
                        <div style="color: #ccc; margin-bottom: 10px;">${tool.description}</div>
                        <div><strong>Cost:</strong> $${tool.cost} / run</div>
                        <div><strong>Branch:</strong> ${tool.branch}</div>
                    </div>
                    
                    <div class="mcp-date">
                        <i class="far fa-calendar"></i> GitHub: <a href="${tool.repo_url}" target="_blank" style="color: #999; text-decoration: underline;">View Repo</a>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="useTool(${tool.id}, '${tool.name}')">
                            <i class="fas fa-play"></i> Run Tool
                        </button>
                        <button class="btn btn-secondary" onclick="showDetails('${tool.name}', '${tool.description}', ${tool.cost})">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // 3. Search/Filter Logic
        function performSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allTools.filter(t => 
                t.name.toLowerCase().includes(query) || 
                t.description.toLowerCase().includes(query)
            );
            renderTools(filtered);
            document.getElementById('resultsCount').innerText = `${filtered.length} eMCPs found`;
        }

        // 4. Functionality: Use/Run the Tool
        async function useTool(toolId, toolName) {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                showAlert("Please log in first!", "error");
                return;
            }

            showAlert(`Running ${toolName}...`, "success");
            
            try {
                const response = await fetch(`${API_BASE_URL}/tools/use/${toolId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    const statusMsg = data.status === 'success' ? 'Success' : 'Failed';
                    alert(`✅ Execution Result:\n\nStatus: ${statusMsg}\nMessage: ${data.message}\nTime: ${data.processing_time}s`);
                } else {
                    throw new Error(data.detail || "Execution failed");
                }
            } catch (error) {
                showAlert(error.message, "error");
            }
        }

        function showDetails(name, desc, cost) {
            alert(`Details for ${name}:\n\n${desc}\n\nCost per run: $${cost}\n\nThis tool is hosted on eMCP Nexus.`);
        }

        // Helper to show floating alerts
        function showAlert(message, type) {
            const existing = document.querySelector('.alert-popup');
            if (existing) existing.remove();

            const alert = document.createElement('div');
            alert.className = 'alert alert-popup';
            alert.style.background = 'rgba(18, 18, 18, 0.95)';
            alert.style.border = '1px solid rgba(255, 255, 255, 0.2)';
            alert.style.borderLeft = `4px solid ${type === 'error' ? '#ff4d4d' : '#4cc9f0'}`;
            alert.style.padding = '15px 20px';
            alert.style.borderRadius = '8px';
            alert.style.color = '#fff';
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.display = 'flex';
            alert.style.alignItems = 'center';
            alert.style.gap = '10px';
            alert.style.boxShadow = '0 5px 15px rgba(0,0,0,0.5)';
            alert.style.minWidth = '300px';
            
            alert.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'info-circle'}" style="color: ${type === 'error' ? '#ff4d4d' : '#4cc9f0'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(alert);

            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.5s ease';
                setTimeout(() => alert.remove(), 500);
            }, 4000);
        }
        // --- Voice Search Feature ---
    const voiceBtn = document.getElementById('voiceBtn');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');

    // Check browser support
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.continuous = false; // Stop listening after one sentence
        recognition.lang = 'en-US';     // Default language
        recognition.interimResults = false;

        voiceBtn.addEventListener('click', () => {
            if (voiceBtn.classList.contains('listening')) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                    // Visual feedback: Add 'listening' class
                    voiceBtn.classList.add('listening');
                    searchInput.placeholder = "Listening...";
                } catch (error) {
                    console.error("Speech recognition start error:", error);
                }
            }
        });

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            searchInput.value = transcript;
            
            // Automatically trigger the search
            performSearch();
        };

        recognition.onend = () => {
            // Reset UI when finished
            voiceBtn.classList.remove('listening');
            searchInput.placeholder = "Search eMCPs, tools, or descriptions...";
        };

        recognition.onerror = (event) => {
            console.error("Speech recognition error", event.error);
            voiceBtn.classList.remove('listening');
            searchInput.placeholder = "Error. Try again.";
        };
    } else {
        // Hide microphone if browser doesn't support API
        voiceBtn.style.display = 'none';
        console.log("Web Speech API not supported in this browser.");
    }
    </script>
</body>
</html>